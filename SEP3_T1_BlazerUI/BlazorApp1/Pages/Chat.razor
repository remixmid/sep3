@page "/chat"
@inject BlazorApp1.Service.ChatHubService ChatHub

<h3>Chat</h3>

<div class="border p-2" style="height:300px; overflow:auto">
    @foreach (var msg in messages)
    {
        <div>
            <strong>@msg.sender.Username:</strong> @msg.message.Content
        </div>
    }
</div>

<input class="form-control mt-2" placeholder="Message..." @bind="newMessage" />
<button class="btn btn-primary mt-2" @onclick="SendAsync">Send</button>

@code {
    private string newMessage = "";
    private List<(DTOs.ModelDTOs.UserDTO sender, DTOs.ModelDTOs.MessageDTO message, DTOs.ModelDTOs.UserDTO recipient)> messages = new();

    protected override async Task OnInitializedAsync()
    {
        ChatHub.OnMessageReceived += (sender, message, recipient) =>
        {
            messages.Add((sender, message, recipient));
            InvokeAsync(StateHasChanged);
        };

        await ChatHub.StartAsync();
    }

    private async Task SendAsync()
    {
        if (string.IsNullOrWhiteSpace(newMessage)) return;

        var sender = new DTOs.ModelDTOs.UserDTO { Username = "you", DisplayName = "You" };
        var recipient = new DTOs.ModelDTOs.UserDTO { Username = "everyone", DisplayName = "Everyone" };
        var message = new DTOs.ModelDTOs.MessageDTO { Content = newMessage };

        await ChatHub.SendMessage(sender, message, recipient);
        newMessage = "";
    }
}